<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" type="text/css" href="../CSS/homePageStyle.css">
<link rel="stylesheet" type="text/css" href="../CSS/dataTable.css">
<title>Dashboard</title>
</head>
<body>
<script>
    // Vérifier si la session est active
    if (sessionStorage.getItem('logged_in')) {
        // Rediriger l'utilisateur vers la page de connexion
        window.location.href = "../view/loginView.html";
    }
</script>

<div class="header">
    <div class="title">
    <h1>Dashboard</h1>
    <p>Welcome, <span id="userFullName"></span></p>
    </div>
    <div class="logout">
    <button type="submit" onclick="window.location.href='../PHP_controller/logoutController.php';">Log Out</button>    
    </div>
</div>

<script>
var userFirstName = "<?php echo $userFirstName; ?>";
var userLastName = "<?php echo $userLastName; ?>";

// Concaténer les variables JavaScript pour former le nom complet de l'utilisateur
var userFullName = userFirstName + " " + userLastName;

// Insérer le nom complet de l'utilisateur dans la balise <span> avec l'identifiant 'userFullName'
document.getElementById("userFullName").textContent = userFullName;
</script>

<div class="container" id="planning">
    <h2>Planning</h2>
    <iframe class="calendar" src="https://calendar.google.com/calendar/embed?height=600&wkst=1&ctz=Europe%2FParis&bgcolor=%23ffffff&src=ZnIuZnJlbmNoI2hvbGlkYXlAZ3JvdXAudi5jYWxlbmRhci5nb29nbGUuY29t&color=%23009688"></iframe>
    <div class="chart">
        <div class="chart-row chart-period">
            <div class="chart-row-item">
                </div><span>January</span><span>February</span><span>March</span>
                <span>April</span><span>May</span><span>June</span><span>July</span>
                <span>August</span><span>September</span><span>October</span>
                <span>November</span><span>December</span>
            </div>
            <div class="chart-row chart-lines"> 
                <span></span><span></span><span></span>
                <span></span><span></span><span></span>
                <span></span><span></span><span></span>
                <span></span><span></span>	<span></span>    
            </div>
            <div class="chart-row">  
                <div class="chart-row-item">1</div> 
                <ul class="chart-row-bars">    
                    <li class="chart-li-one">Planning</li>
                </ul>
                <div class="chart-row-item">2</div> 
                <ul class="chart-row-bars">    
                    <li class="chart-li-one">Exercute</li>
                </ul>
                <div class="chart-row-item">3</div> 
                <ul class="chart-row-bars">    
                    <li class="chart-li-one">Exercute</li>
                </ul>
                <div class="chart-row-item">4</div> 
                <ul class="chart-row-bars">    
                    <li class="chart-li-one">Exercute</li>
                </ul>
                <div class="chart-row-item">5</div> 
                <ul class="chart-row-bars">    
                    <li class="chart-li-one">Exercute</li>
                </ul>    
            </div>
    </div>
</div>

<div id="structure">
<div class="container" id="form">
    <h2>Ajouter une tâche</h2>
    <form action="../PHP_controller/homepageController.php" method="post">
        <label for="nom">Nom :</label>
        <input type="text" id="nom" name="nom" required><br><br>

        <label for="priority">Priorité :</label>
        <select id="priority" name="priority" required>
            <option value="">Selectionnez une priorité</option>
            <option value="1">Basse</option>
            <option value="2">Moyenne</option>
            <option value="3">Haute</option>
            <option value="4">Digne d'un partiel de dev web</option>
        </select><br><br>

        <label for="type">Type :</label>
        <select id="type" name="type" required>
            <option value="">Selectionnez une valeur</option>
            <option value="1">Graphisme</option>
            <option value="2">Documentation</option>
            <option value="3">Requirements</option>
            <option value="4">Developement</option>
        </select><br><br>

        <label for="Assignee">Assigné a:</label>
        <select id="Assignee" name="Assignee" required>
        </select><br><br>


        <label for="pastel1">Couleur :</label> <br>
        <div class="colorSelector">
            <div>
                <input type="radio" id="pastel1" name="couleur" value="0">
                <label for="pastel1" style="background-color: #fde2e4; padding: 10px; border: 1px solid #000;">Pivoine   </label><br>
            </div>
            <div>
                <input type="radio" id="pastel2" name="couleur" value="1">
                <label for="pastel2" style="background-color: #accbe1; padding: 10px; border: 1px solid #000;">Myosotis  </label><br>
            </div>
            <div>
                <input type="radio" id="pastel3" name="couleur" value="2">
                <label for="pastel3" style="background-color: #9fd8df; padding: 10px; border: 1px solid #000;">Hortensia </label><br>
            </div>
            <div>
                <input type="radio" id="pastel4" name="couleur" value="3">
                <label for="pastel4" style="background-color: #97c1a9; padding: 10px; border: 1px solid #000;">Eucalyptus</label><br>
            </div>
            <div>
                <input type="radio" id="pastel5" name="couleur" value="4">
                <label for="pastel5" style="background-color: #e4cbf8; padding: 10px; border: 1px solid #000;">Lotus     </label><br><br>
            </div>
        </div>
        

        <label for="dateDebut">Date de début :</label>
        <input type="date" id="dateDebut" name="dateDebut" required><br><br>

        <label for="dateFin">Date de fin :</label>
        <input type="date" id="dateFin" name="dateFin" required><br><br>

        <label for="tempsEstime">Temps estimé (en heures) :</label>
        <input type="number" id="tempsEstime" name="tempsEstime" min="0" step="0.5" required><br><br>

        <button type="submit">Ajouter un tache </button>
    </form>
</div>

<section class="container" id="TaskViewer">
    <h2> Tâches </h2>
    <div class="TableGrid">
        <!-- Contextual Menu -->
        <div id="contextMenu">
            <ul>
                <li onclick="NewRow()">Add Row</li>
                <li onclick="NewCol()">Add Column</li>
                <li onclick="DelRow()">Delete Row</li>
                <li onclick="DelCol()">Delete Column</li>
            </ul>
        </div>
        <div class="Table">
            <table id="T1">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Type</th>
                        <th>État</th>
                        <th>Date de début</th>
                        <th>Date de fin</th>
                        <th>Temps estimé</th>
                        <th>Assignée à</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div class="AddColumn" style="display: none;"> +</div>
        <div class="AddRow" style="display: none;"> + </div>
    </div>
</section>
</div>

<div class="container" id="financial">
    <h2>Prévisionel budgétaire</h2>
    <div class="financialTable">
    <div class="budget">
        <h2>Actuel</h2>
        <table>
          <tr>
            <th>Coût total</th>
            <td>8000€</td>
          </tr>
          <tr>
            <th>Nombre heures totales</th>
            <td>8</td>
          </tr>
          <tr>
            <th>Coût horaire</th>
            <td>1000€/h</td>
          </tr>
          <tr>
            <th>Guillaume Fleuve</th>
            <td>1h</td>
          </tr>
          <tr>
            <th>Yvol Tousles</th>
            <td>499h</td>
          </tr>
          <tr>
            <th>Vivy Leclerc</th>
            <td>500h</td>
          </tr>
        </table>
      </div>
      <div class="budget">
        <h2>Futur</h2>
        <table>
          <tr>
            <th>Tâches planifiées</th>
            <td>12</td>
          </tr>
          <tr>
            <th>Coût tâches planifiées</th>
            <td>1200€</td>
          </tr>
          <tr>
            <th>Coût total projet</th>
            <td>9200€</td>
          </tr>
          <tr>
            <th>Nombre d'heures planifiées</th>
            <td>1.2h</td>
          </tr>
          <tr>
            <th>Guillaume Fleuve</th>
            <td>0h</td>
          </tr>
          <tr>
            <th>Yvol Tousles</th>
            <td>0.2h</td>
          </tr>
          <tr>
            <th>Vivy Leclerc</th>
            <td>1h</td>
          </tr>
        </table>
      </div>
    </div>
</div>

<div class="structureNext">
  <div class="container" id="validate">
      <h2>Modifier l'état de la tâche</h2>
      <form>
          <div class="form-group">
              <label for="tache-selection">Sélectionner la tâche</label>
              <select id="tache-selection" name="tache-selection">
              </select>
          </div>
          <div class="form-group">
              <label for="etat">État de la tâche</label>
              <input type="text" id="etat" name="etat" value="Validated" readonly>
          </div>
          <div class="validate-button">
              <button type="submit" id="state-button" class="btn">Valider</button>
              <button type="button" id="state-button2" class="btn" style="display: none;">Valider</button>
          </div>
      </form>
  </div>

  <div class="container" id="history">
      <h2>Historique des tâches</h2>
      <div class="form-group">
          <label for="tache-selection">Tâches</label>
          <select id="tache-selection-2" onchange="updateTaskDetails()">
          </select>
      </div>
      <div class="task-details">
          <h3>Détails de la Tâche</h3>
          <p><strong>ID :</strong> <input type="text" id="task-id" readonly></p>
          <p><strong>Nom :</strong> <input type="text" id="task-name" readonly></p>
          <p><strong>Type ID :</strong> <input type="text" id="task-id_type" readonly></p>
          <p><strong>État ID :</strong> <input type="text" id="task-id_state" readonly></p>
          <p><strong>Validée :</strong> <input type="text" id="task-is_validated" readonly></p>
          <p><strong>Couleur :</strong> <input type="text" type="text"an id="task-color" readonly></p>
          <p><strong>Date de début :</strong> <input type="text" id="task-date_debut" readonly></p>
          <p><strong>Date de fin :</strong> <input type="text" id="task-date_fin" readonly></p>
          <p><strong>Temps estimé :</strong> <input type="text" id="task-estimated_time" readonly></p>
          <p><strong>Créé le :</strong> <input type="text" id="task-created_at" readonly></p>
      </div>
  </div>
</div>

<footer class="footer">
    <div class="waves">
    <div class="wave" id="wave1"></div>
    <div class="wave" id="wave2"></div>
    <div class="wave" id="wave3"></div>
    <div class="wave" id="wave4"></div>
    </div>
    <p>&copy;2024 Barut Benhamou Brana | All Rights Reserved for ESTIA - Project TAI Limited&copy;</p>
</footer>
<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
<script src="../JS/TableManager.js"></script>
<script>
    // Récupérer les données JSON des tâches depuis l'attribut data-tasks
    var tasksJsonString = '<?php echo addslashes($tasks_json); ?>';
    var tasks = JSON.parse(tasksJsonString);

    // Dictionnaire des couleurs en fonction de l'ID
    var colorMap = {
        0: '#fde2e4',
        1: '#accbe1',
        2: '#9fd8df',
        3: '#97c1a9',
        4: '#e4cbf8'
    };

    // Fonction pour créer et ajouter une ligne de tâche au tableau
    function addTaskRow(task) {
        var table = document.getElementById("T1").getElementsByTagName('tbody')[0];
        var newRow = table.insertRow(table.rows.length);

        // Appliquer la couleur de fond en fonction de l'ID de la couleur
        var color = colorMap[task.color];
        newRow.style.backgroundColor = color;

        var cellNames = ['name', 'type', 'state', 'date_debut', 'date_fin', 'estimated_time', 'assigned_to'];
        console.log(cellNames);
        cellNames.forEach(function(cellName) {
            var cell = newRow.insertCell();
            if (cellName === 'assigned_to') {
                // Combiner firstname et employee_name dans une seule cellule
                cell.appendChild(document.createTextNode(task.firstname + ' ' + task.employee_name));
            } else {
                cell.appendChild(document.createTextNode(task[cellName]));
            }
        });
    }

    // Ajouter chaque tâche au tableau
    tasks.forEach(function(task) {
        addTaskRow(task);
    });

    // Récupérer les données JSON des assignés depuis l'attribut data-tasks
    var assigneesJsonString = '<?php echo addslashes($assignees_json); ?>';
    var assignees = JSON.parse(assigneesJsonString);

    // Remplir le menu déroulant avec les noms des salariés
    function addAssignee(assignee) {
            var select = document.getElementById("Assignee");
            var option = document.createElement("option");
            option.value = assignee.id;  // Utiliser l'ID du salarié comme valeur
            option.text = assignee.firstname + " " + assignee.name; // Utiliser le nom du salarié comme texte
            select.add(option);
    }

    // Ajouter chaque tâche au menu déroulant
    assignees.forEach(function(assignee) {
        addAssignee(assignee);
    });

    // Remplir le menu déroulant avec les noms des tâches
    function addTaskOption(task) {
        addToSelect(task, "tache-selection");
        addToSelect(task, "tache-selection-2");
    }

    function addToSelect(task, selectId) {
        var select = document.getElementById(selectId);
        var option = document.createElement("option");
        option.value = task.id;  // Utiliser l'ID de la tâche comme valeur
        option.text = task.name; // Utiliser le nom de la tâche comme texte
        select.add(option);
    }

    // Ajouter chaque tâche au menu déroulant
    tasks.forEach(function(task) {
        addTaskOption(task);
    });

    // Mettre à jour l'état de la tâche sélectionnée
    document.getElementById("tache-selection").addEventListener("change", function() {
        var selectedTaskId = this.value;
        var selectedTask = tasks.find(task => task.id == selectedTaskId);
        if (selectedTask) {
            document.getElementById("etat").value = selectedTask.state;

            // Changer le texte du bouton si l'état est "On hold"
            var validateBtn = document.getElementById("state-button");
            var validateBtn2 = document.getElementById("state-button2");
            if (selectedTask.state === "On hold") {
                validateBtn.style.display = "inline";
                validateBtn.textContent = "Rouvrir";
                validateBtn2.style.display = "none";
            } else if (selectedTask.state === "Current") {
                validateBtn.style.display = "inline";
                validateBtn.textContent = "Mettre en attente";
                validateBtn2.style.display = "inline";
                validateBtn2.textContent = "Valider";
            } else if (selectedTask.state === "Validated") {
                validateBtn.style.display = "inline";
                validateBtn.textContent = "Rouvrir";
                validateBtn2.style.display = "inline";
                validateBtn2.textContent = "Fermer";
            } else if (selectedTask.state === "Closed") {
                validateBtn.style.display = "none";
                validateBtn2.style.display = "none";
            }
        }
    });

    // Initialiser l'état avec la première tâche
    if (tasks.length > 0) {
        var initialTask = tasks[0];
        document.getElementById("etat").value = initialTask.state;

        var validateBtn = document.getElementById("state-button");
        var validateBtn2 = document.getElementById("state-button2");
        if (initialTask.state === "On hold") {
            validateBtn.style.display = "inline";
            validateBtn.textContent = "Rouvrir";
            validateBtn2.style.display = "none";
        } else if (initialTask.state === "Current") {
            validateBtn.style.display = "inline";
            validateBtn.textContent = "Mettre en attente";
            validateBtn2.style.display = "inline";
            validateBtn2.textContent = "Valider";
        } else if (initialTask.state === "Validated") {
            validateBtn.style.display = "inline";
            validateBtn.textContent = "Rouvrir";
            validateBtn2.style.display = "inline";
            validateBtn2.textContent = "Fermer";
        } else if (initialTask.state === "Closed") {
            validateBtn.style.display = "none";
            validateBtn2.style.display = "none";
        }
    }

    // Mettre à jour l'état de la tâche sélectionnée
    document.getElementById("tache-selection-2").addEventListener("change", function() {
        var selectedTaskId = this.value;
        var selectedTask = tasks.find(task => task.id == selectedTaskId);
        if (selectedTask) {
            document.getElementById("task-id").value = selectedTask.id;
            document.getElementById("task-name").value = selectedTask.name;
            document.getElementById("task-id_type").value = selectedTask.type;
            document.getElementById("task-id_state").value = selectedTask.state;
            document.getElementById("task-is_validated").value = selectedTask.is_validated;
            // Appliquer la couleur de fond en fonction de l'ID de la couleur
            taskColor = document.getElementById("task-color");
            var color = colorMap[selectedTask.color];
            taskColor.style.backgroundColor = color;
            document.getElementById("task-date_debut").value = selectedTask.date_debut;
            document.getElementById("task-date_fin").value = selectedTask.date_fin;
            document.getElementById("task-estimated_time").value = selectedTask.estimated_time + "h";
            document.getElementById("task-created_at").value = selectedTask.created_at;
        }
    });

    // Initialiser l'état avec la première tâche
    if (tasks.length > 0) {
        var initialTask = tasks[0];
        document.getElementById("task-id").value = initialTask.id;
        document.getElementById("task-name").value = initialTask.name;
        document.getElementById("task-id_type").value = initialTask.type;
        document.getElementById("task-id_state").value = initialTask.state;
        document.getElementById("task-is_validated").value = initialTask.is_validated;
        // Appliquer la couleur de fond en fonction de l'ID de la couleur
        taskColor = document.getElementById("task-color");
        var color = colorMap[initialTask.color];
        taskColor.style.backgroundColor = color;
        document.getElementById("task-date_debut").value = initialTask.date_debut;
        document.getElementById("task-date_fin").value = initialTask.date_fin;
        document.getElementById("task-estimated_time").value = initialTask.estimated_time + "h";
        document.getElementById("task-created_at").value = initialTask.created_at;
    }
</script>
</body>
</html>
